name: publish-platforms

on:
  workflow_dispatch:
    inputs:
      dataset_id:
        description: "Dataset id to publish"
        required: true
        default: "demo_dataset"
      target:
        description: "Target platform"
        required: true
        default: "all"
        type: choice
        options: ["all", "hf", "kaggle"]

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
      - name: Set up Python
        run: uv python install 3.11
      - name: Install dependencies
        run: uv sync --all-extras --frozen
      - name: Build dataset first
        run: uv run hdb run ${{ github.event.inputs.dataset_id }}
      - name: Publish Hugging Face
        if: ${{ (github.event.inputs.target == 'all' || github.event.inputs.target == 'hf') && secrets.HF_TOKEN != '' && vars.HDB_HF_DATASET_REPO_ID != '' && vars.HDB_HF_MODEL_REPO_ID != '' }}
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HDB_HF_DATASET_REPO_ID: ${{ vars.HDB_HF_DATASET_REPO_ID }}
          HDB_HF_MODEL_REPO_ID: ${{ vars.HDB_HF_MODEL_REPO_ID }}
        run: uv run hdb publish-hf ${{ github.event.inputs.dataset_id }}
      - name: Publish Kaggle
        if: ${{ (github.event.inputs.target == 'all' || github.event.inputs.target == 'kaggle') && secrets.KAGGLE_USERNAME != '' && secrets.KAGGLE_KEY != '' && vars.HDB_KAGGLE_DATASET_SLUG != '' && vars.HDB_KAGGLE_MODEL_SLUG != '' }}
        env:
          KAGGLE_USERNAME: ${{ secrets.KAGGLE_USERNAME }}
          KAGGLE_KEY: ${{ secrets.KAGGLE_KEY }}
          HDB_KAGGLE_DATASET_SLUG: ${{ vars.HDB_KAGGLE_DATASET_SLUG }}
          HDB_KAGGLE_MODEL_SLUG: ${{ vars.HDB_KAGGLE_MODEL_SLUG }}
        run: |
          uv pip install kaggle
          uv run hdb publish-kaggle ${{ github.event.inputs.dataset_id }}

