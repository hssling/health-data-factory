name: nightly-build

on:
  schedule:
    - cron: "0 2 * * *"
  workflow_dispatch:
    inputs:
      dataset_id:
        description: "Dataset id to build"
        required: false
        default: "demo_dataset"
      full_refresh:
        description: "Run full refresh"
        required: false
        default: "false"
        type: choice
        options: ["false", "true"]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v4
      - name: Set up Python
        run: uv python install 3.11
      - name: Sync deps
        run: uv sync --all-extras --frozen
      - name: Build dataset
        run: |
          if [ "${{ github.event.inputs.full_refresh || 'false' }}" = "true" ]; then
            uv run hdb run ${{ github.event.inputs.dataset_id || 'demo_dataset' }} --full-refresh
          else
            uv run hdb run ${{ github.event.inputs.dataset_id || 'demo_dataset' }}
          fi
      - name: Validate dataset
        run: uv run hdb validate ${{ github.event.inputs.dataset_id || 'demo_dataset' }}
      - name: Export OMOP
        run: uv run hdb export-omop ${{ github.event.inputs.dataset_id || 'demo_dataset' }}
      - name: Export FHIR
        run: uv run hdb export-fhir ${{ github.event.inputs.dataset_id || 'demo_dataset' }}
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dataset-artifacts
          path: |
            data/gold/
            manifests/
      - name: Publish to Hugging Face (optional)
        if: ${{ secrets.HF_TOKEN != '' && vars.HDB_HF_DATASET_REPO_ID != '' && vars.HDB_HF_MODEL_REPO_ID != '' }}
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HDB_HF_DATASET_REPO_ID: ${{ vars.HDB_HF_DATASET_REPO_ID }}
          HDB_HF_MODEL_REPO_ID: ${{ vars.HDB_HF_MODEL_REPO_ID }}
        run: uv run hdb publish-hf ${{ github.event.inputs.dataset_id || 'demo_dataset' }}
      - name: Publish to Kaggle (optional)
        if: ${{ secrets.KAGGLE_USERNAME != '' && secrets.KAGGLE_KEY != '' && vars.HDB_KAGGLE_DATASET_SLUG != '' && vars.HDB_KAGGLE_MODEL_SLUG != '' }}
        env:
          KAGGLE_USERNAME: ${{ secrets.KAGGLE_USERNAME }}
          KAGGLE_KEY: ${{ secrets.KAGGLE_KEY }}
          HDB_KAGGLE_DATASET_SLUG: ${{ vars.HDB_KAGGLE_DATASET_SLUG }}
          HDB_KAGGLE_MODEL_SLUG: ${{ vars.HDB_KAGGLE_MODEL_SLUG }}
        run: |
          uv pip install kaggle
          uv run hdb publish-kaggle ${{ github.event.inputs.dataset_id || 'demo_dataset' }}
